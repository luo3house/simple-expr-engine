!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).simple_expr_engine={})}(this,(function(e){"use strict";function r(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function t(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function n(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function o(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function a(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),r&&i(e,r)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}function i(e,r){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,r){return e.__proto__=r,e},i(e,r)}function s(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function c(e,r,t){return c=s()?Reflect.construct.bind():function(e,r,t){var n=[null];n.push.apply(n,r);var o=new(Function.bind.apply(e,n));return t&&i(o,t.prototype),o},c.apply(null,arguments)}function l(e){var r="function"==typeof Map?new Map:void 0;return l=function(e){if(null===e||(t=e,-1===Function.toString.call(t).indexOf("[native code]")))return e;var t;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,n)}function n(){return c(e,arguments,u(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),i(n,e)},l(e)}function h(e,r){if(r&&("object"==typeof r||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function p(e){var r=s();return function(){var t,n=u(e);if(r){var o=u(this).constructor;t=Reflect.construct(n,arguments,o)}else t=n.apply(this,arguments);return h(this,t)}}var f,v;e.Operator=void 0,(f=e.Operator||(e.Operator={})).AND="and",f.OR="or",f.EQ="==",f.NE="!=",f.LT="<",f.GT=">",f.LTE="<=",f.GTE=">=",e.ExprGrammar=void 0,(v=e.ExprGrammar||(e.ExprGrammar={}))[v.Expr=0]="Expr",v[v.ExprOpExpr=1]="ExprOpExpr",v[v.ValueOpValue=2]="ValueOpValue";var d,E=n((function e(t){r(this,e),this.context=t})),w=function(){function t(e){r(this,t),this.context=e}return n(t,[{key:"getGrammar",value:function(){var r=this.left,n=this.op,o=this.right;return r instanceof t&&null===n&&null===o?e.ExprGrammar.Expr:r instanceof t&&null!==n&&o instanceof t?e.ExprGrammar.ExprOpExpr:r instanceof y&&null!==n&&o instanceof y?e.ExprGrammar.ValueOpValue:null}}]),t}(),m=n((function e(t,n){r(this,e),this.context=t,this.op=n})),y=n((function e(t,n){r(this,e),this.context=t,this.valueHolder=n})),O=function(e){a(o,e);var t=p(o);function o(e,n){var a;return r(this,o),(a=t.call(this,e,e.variableStore.findByName(n).holder)).context=e,a.name=n,a}return n(o)}(y);e.VarType=void 0,(d=e.VarType||(e.VarType={}))[d.BOOL=0]="BOOL",d[d.NUMBER=1]="NUMBER",d[d.STRING=2]="STRING";var R=function(){function t(e,n){r(this,t),this.type=e,this.value=n}return n(t,[{key:"getType",value:function(){return this.type}},{key:"getRawValue",value:function(){return this.value}},{key:"asBoolean",value:function(){return!0===this.value}},{key:"asNumber",value:function(){return parseFloat("".concat(this.value))}},{key:"asString",value:function(){return"".concat(this.value)}},{key:"cast",value:function(r){switch(r){case e.VarType.BOOL:switch(this.type){case e.VarType.NUMBER:return t.newBOOL(0!==this.asNumber());case e.VarType.STRING:return t.newBOOL(this.asString().length>0)}break;case e.VarType.NUMBER:switch(this.type){case e.VarType.BOOL:return t.newNUMBER(this.asBoolean()?1:0);case e.VarType.STRING:return t.newNUMBER(this.asNumber())}break;case e.VarType.STRING:switch(this.type){case e.VarType.BOOL:return t.newSTRING(this.asBoolean()?"true":"false");case e.VarType.NUMBER:return t.newSTRING("".concat(this.asNumber()))}}return this}},{key:"equalsValueType",value:function(e){return this.getType()===e.getType()}},{key:"equalsValue",value:function(e){return!!this.equalsValueType(e)&&this.value===e.getRawValue()}},{key:"equalsValueWithTypeCast",value:function(e){return this.cast(e.type).equalsValue(e)}}]),t}();o(R,"newBOOL",(function(){var r=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return new R(e.VarType.BOOL,r)})),o(R,"newNUMBER",(function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new R(e.VarType.NUMBER,r)})),o(R,"newSTRING",(function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return new R(e.VarType.STRING,r)}));var T=function(){function e(t,n,o){r(this,e),this.id=t,this.name=n,this.holder=o}return n(e,null,[{key:"defineBOOL",value:function(r){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:++this.nextId;return new e(n,r,R.newBOOL(t))}},{key:"defineNUMBER",value:function(r){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:++this.nextId;return new e(n,r,R.newNUMBER(t))}},{key:"defineSTRING",value:function(r){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:++this.nextId;return new e(n,r,R.newSTRING(t))}}]),e}();o(T,"nextId",0);var b,k,x,N=function(){function e(t){r(this,e),this.list=t}return n(e,[{key:"findByName",value:function(e){return this.list.filter((function(r){return r.name===e}))[0]}}]),e}();e.TokenizerErrors=void 0,b=e.TokenizerErrors||(e.TokenizerErrors={}),k=function(e){a(o,e);var t=p(o);function o(e){return r(this,o),t.call(this,"unrecognized token: ".concat(e))}return n(o)}(l(Error)),b.TokenNotRecognizeError=k,e.Morpheme=void 0,(x=e.Morpheme||(e.Morpheme={}))[x.LEFT_BRACKET=0]="LEFT_BRACKET",x[x.RIGHT_BRACKET=1]="RIGHT_BRACKET",x[x.VAR=2]="VAR",x[x.OPERATOR=3]="OPERATOR",x[x.RESULT_POINTING=4]="RESULT_POINTING",x[x.BOOL=5]="BOOL",x[x.NUMBER=6]="NUMBER",x[x.STRING=7]="STRING";var B,g=e.Morpheme.LEFT_BRACKET,M=e.Morpheme.RIGHT_BRACKET,S=e.Morpheme.VAR,V=e.Morpheme.RESULT_POINTING,G=e.Morpheme.BOOL,I=e.Morpheme.NUMBER,L=e.Morpheme.STRING,U=e.Morpheme.OPERATOR,P=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";r(this,t),this.morpheme=e,this.chars=n}return n(t,[{key:"unescapeSTRING",value:function(){var e=this.chars.split("");return e.shift(),e.pop(),e.join("")}},{key:"toString",value:function(){return"Token<".concat(this.morpheme,",").concat(this.chars,">")}}],[{key:"newReader",value:function(e){return new(function(){function t(){var e=this;r(this,t),o(this,"charsReaded",[]),o(this,"offset",0),o(this,"getCharsReaded",(function(){return e.charsReaded.join(" ")}))}return n(t,[{key:"read",value:function(){var r,t=null!==(r=e[this.offset])&&void 0!==r?r:null;return t&&(this.offset++,this.charsReaded.push(t.chars)),t}},{key:"rollback",value:function(){this.charsReaded.pop(),this.offset--}}]),t}())}},{key:"recognize",value:function(r){for(var t=0;t<this.TokenRecognizers.length;t++){var n=this.TokenRecognizers[t](r);if(!1!==n)return n}throw new e.TokenizerErrors.TokenNotRecognizeError(r)}},{key:"recognizeAll",value:function(e){for(var r=[],n=0;n<e.length;n++)r.push(t.recognize(e[n]));return r}},{key:"escapeStringCharacters",value:function(e){for(var r=[],t=[],n=function(){var e=t.join("").trim();e.length&&r.push(e),t=[]},o=0;o<e.length;o++){var a=e[o];'"'===t[0]?(t.push(a),'"'===a&&n()):" "===a?n():('"'===a&&n(),t.push(a))}return n(),r}}]),t}();o(P,"TokenRecognizers",[function(e){return/^(\()$/.test(e)&&new P(g,e)},function(e){return/^\)$/.test(e)&&new P(M,e)},function(r){return/^(and)$/.test(r)&&new P(U,e.Operator.AND)},function(r){return/^(or)$/.test(r)&&new P(U,e.Operator.OR)},function(e){return/^(=>)$/.test(e)&&new P(V,e)},function(r){return/^(!=)$/.test(r)&&new P(U,e.Operator.NE)},function(r){return/^(<=)$/.test(r)&&new P(U,e.Operator.LTE)},function(r){return/^(>=)$/.test(r)&&new P(U,e.Operator.GTE)},function(r){return/^(==)$/.test(r)&&new P(U,e.Operator.EQ)},function(r){return/^(<)$/.test(r)&&new P(U,e.Operator.LT)},function(r){return/^(>)$/.test(r)&&new P(U,e.Operator.GT)},function(e){return/^(-{0,1}[0-9]+(\.[0-9]+){0,1})$/.test(e)&&new P(I,e)},function(e){return/^(true|false)$/.test(e)&&new P(G,e)},function(e){return/^"(([^"])*)"$/.test(e)&&new P(L,e)},function(e){return/^(([a-zA-Z]|_)((\w|_)*))$/.test(e)&&new P(S,e)}]),e.ParseErrors=void 0,function(e){var t=function(e){a(o,e);var t=p(o);function o(e){var n;return r(this,o),(n=t.call(this,"unexpected morpheme ".concat(e.toString()))).token=e,n}return n(o)}(l(Error));e.UnexpectedMorphemeError=t;var o=function(e){a(o,e);var t=p(o);function o(){return r(this,o),t.call(this,"unexpected EOF")}return n(o)}(l(Error));e.UnexpectedEOFError=o}(e.ParseErrors||(e.ParseErrors={})),function(t){var o=function(){function t(){r(this,t)}return n(t,[{key:"mustReadToken",value:function(r){var t=r.read();if(!t)throw new e.ParseErrors.UnexpectedEOFError;return t}}]),t}();t.BaseState=o;var u=function(e){a(o,e);var t=p(o);function o(){return r(this,o),t.apply(this,arguments)}return n(o,[{key:"build",value:function(e,r,t,n){n.setState(new i)}}]),o}(o);t.Begin=u;var i=function(t){a(u,t);var o=p(u);function u(){return r(this,u),o.apply(this,arguments)}return n(u,[{key:"build",value:function(r,t,n,o){var a=this.mustReadToken(n);if(a.morpheme!==e.Morpheme.LEFT_BRACKET)throw new e.ParseErrors.UnexpectedMorphemeError(a);o.setState(new s)}}]),u}(o);t.ReadLeftBracket=i;var s=function(t){a(u,t);var o=p(u);function u(){return r(this,u),o.apply(this,arguments)}return n(u,[{key:"build",value:function(r,t,n,o){var a=this.mustReadToken(n);switch(a.morpheme){case e.Morpheme.LEFT_BRACKET:n.rollback(),t.left=new _(r,n).build();break;case e.Morpheme.VAR:t.left=new O(r,a.chars);break;case e.Morpheme.BOOL:t.left=new y(t.context,R.newBOOL("true"===a.chars));break;case e.Morpheme.NUMBER:t.left=new y(t.context,R.newNUMBER(parseFloat(a.chars)));break;case e.Morpheme.STRING:t.left=new y(t.context,R.newSTRING(a.unescapeSTRING()));break;default:throw new e.ParseErrors.UnexpectedMorphemeError(a)}o.setState(new c)}}]),u}(o);t.ReadLeft=s;var c=function(t){a(u,t);var o=p(u);function u(){return r(this,u),o.apply(this,arguments)}return n(u,[{key:"build",value:function(r,t,n,o){var a=this.mustReadToken(n);switch(a.morpheme){case e.Morpheme.RIGHT_BRACKET:o.setState(new f);break;case e.Morpheme.OPERATOR:t.op=new m(t.context,a.chars);break;default:throw new e.ParseErrors.UnexpectedMorphemeError(a)}o.setState(new l)}}]),u}(o);t.ReadOp=c;var l=function(t){a(u,t);var o=p(u);function u(){return r(this,u),o.apply(this,arguments)}return n(u,[{key:"build",value:function(r,t,n,o){var a=this.mustReadToken(n);switch(a.morpheme){case e.Morpheme.LEFT_BRACKET:n.rollback(),t.right=o.buildExpr(t.context,n);break;case e.Morpheme.VAR:t.right=new O(r,a.chars);break;case e.Morpheme.BOOL:t.right=new y(t.context,R.newBOOL("true"===a.chars));break;case e.Morpheme.NUMBER:t.right=new y(t.context,R.newNUMBER(parseFloat(a.chars)));break;case e.Morpheme.STRING:t.right=new y(t.context,R.newSTRING(a.unescapeSTRING()));break;default:throw new e.ParseErrors.UnexpectedMorphemeError(a)}o.setState(new h)}}]),u}(o);t.ReadRight=l;var h=function(t){a(u,t);var o=p(u);function u(){return r(this,u),o.apply(this,arguments)}return n(u,[{key:"build",value:function(r,t,n,o){var a=this.mustReadToken(n);switch(a.morpheme){case e.Morpheme.RIGHT_BRACKET:o.setState(new f);break;case e.Morpheme.OPERATOR:var u=new w(r);u.left=t.left,u.op=t.op,u.right=t.right,t.left=u,t.right=null,n.rollback(),o.setState(new c);break;default:throw new e.ParseErrors.UnexpectedMorphemeError(a)}}}]),u}(o);t.ReadRightBracket=h;var f=function(e){a(o,e);var t=p(o);function o(){return r(this,o),t.apply(this,arguments)}return n(o,[{key:"build",value:function(e,r,t,n){}}]),o}(o);t.End=f}(B||(B={}));var A,_=function(){function e(t,n){r(this,e),o(this,"state",new B.Begin),this.context=t,this.reader=n,this.expr=new w(t)}return n(e,[{key:"buildExpr",value:function(r,t){return new e(r,t).build()}},{key:"setState",value:function(e){this.state=e}},{key:"build",value:function(){for(var e=!1;!e;)if(this.state.build(this.context,this.expr,this.reader,this),this.state.constructor===B.End){e=!0;break}return this.expr}}]),e}();!function(t){var o=function(){function t(){r(this,t)}return n(t,[{key:"mustReadToken",value:function(r){var t=r.read();if(!t)throw new e.ParseErrors.UnexpectedEOFError;return t}}]),t}();t.BaseState=o;var u=function(t){a(u,t);var o=p(u);function u(){return r(this,u),o.apply(this,arguments)}return n(u,[{key:"build",value:function(r,t,n,o){var a=this.mustReadToken(n);if(a.morpheme!==e.Morpheme.LEFT_BRACKET)throw new e.ParseErrors.UnexpectedMorphemeError(a);n.rollback(),t.expr=new _(r,n).build(),o.setState(new i)}}]),u}(o);t.Begin=u;var i=function(t){a(u,t);var o=p(u);function u(){return r(this,u),o.apply(this,arguments)}return n(u,[{key:"build",value:function(r,t,n,o){var a=this.mustReadToken(n);if(a.morpheme!==e.Morpheme.RESULT_POINTING)throw new e.ParseErrors.UnexpectedMorphemeError(a);o.setState(new s)}}]),u}(o);t.ReadArrow=i;var s=function(t){a(u,t);var o=p(u);function u(){return r(this,u),o.apply(this,arguments)}return n(u,[{key:"build",value:function(r,t,n,o){var a=this.mustReadToken(n);switch(a.morpheme){case e.Morpheme.VAR:t.result=new O(r,a.chars);break;case e.Morpheme.BOOL:t.result=new y(r,R.newBOOL("true"===a.chars));break;case e.Morpheme.NUMBER:t.result=new y(r,R.newNUMBER(parseFloat(a.chars)));break;case e.Morpheme.STRING:t.result=new y(r,R.newSTRING(a.unescapeSTRING()));break;default:throw new e.ParseErrors.UnexpectedMorphemeError(a)}o.setState(new c)}}]),u}(o);t.ReadResult=s;var c=function(e){a(o,e);var t=p(o);function o(){return r(this,o),t.apply(this,arguments)}return n(o,[{key:"build",value:function(e,r,t,n){}}]),o}(o);t.End=c}(A||(A={}));var H,C,F,j=function(){function e(t,n){r(this,e),o(this,"state",new A.Begin),this.context=t,this.reader=n,this.rule=new E(t)}return n(e,[{key:"setState",value:function(e){this.state=e}},{key:"build",value:function(){for(var e=!1;!e;)if(this.state.build(this.context,this.rule,this.reader,this),this.state.constructor===A.End){e=!0;break}return this.rule}}]),e}(),z=function(){function e(){r(this,e)}return n(e,null,[{key:"buildRules",value:function(e,r){var t=[];return r.forEach((function(r){var n=P.escapeStringCharacters(r.split(""));t.push(new j(e,P.newReader(P.recognizeAll(n))).build())})),t}},{key:"buildExpr",value:function(e,r){var t=P.escapeStringCharacters(r.split(""));return new _(e,P.newReader(P.recognizeAll(t))).build()}}]),e}();e.InterpretErrors=void 0,H=e.InterpretErrors||(e.InterpretErrors={}),C=function(e){a(o,e);var t=p(o);function o(){return r(this,o),t.call(this,"no rule result is return out")}return n(o)}(l(Error)),H.NoRuleResultError=C,function(t){var o=function(){function t(){r(this,t)}return n(t,null,[{key:"result",value:function(r){r.context;var n=r.left,o=r.op,u=r.right;switch(r.getGrammar()){case e.ExprGrammar.Expr:return t.result(n);case e.ExprGrammar.ExprOpExpr:return a.resultExprOpExpr(o,n,u);case e.ExprGrammar.ValueOpValue:return a.resultValueValue(o,n,u);default:return!1}}}]),t}();t.ExprResult=o;var a=function(){function t(){r(this,t)}return n(t,null,[{key:"resultExprOpExpr",value:function(r,t,n){switch(r.op){case e.Operator.AND:return o.result(t)&&o.result(n);case e.Operator.OR:return o.result(t)||o.result(n);default:return!1}}},{key:"resultValueValue",value:function(r,t,n){switch(r.op){case e.Operator.AND:return t.valueHolder.cast(e.VarType.BOOL).asBoolean()&&n.valueHolder.cast(e.VarType.BOOL).asBoolean();case e.Operator.OR:return t.valueHolder.cast(e.VarType.BOOL).asBoolean()||n.valueHolder.cast(e.VarType.BOOL).asBoolean();case e.Operator.EQ:return t.valueHolder.equalsValueWithTypeCast(n.valueHolder);case e.Operator.NE:return!t.valueHolder.equalsValueWithTypeCast(n.valueHolder);case e.Operator.LT:return t.valueHolder.asNumber()<n.valueHolder.asNumber();case e.Operator.GT:return t.valueHolder.asNumber()>n.valueHolder.asNumber();case e.Operator.LTE:return t.valueHolder.asNumber()<=n.valueHolder.asNumber();case e.Operator.GTE:return t.valueHolder.asNumber()>=n.valueHolder.asNumber();default:return!1}}}]),t}();t.OpResult=a}(F||(F={}));var $=function(){function t(){r(this,t)}return n(t,null,[{key:"interpretExpr",value:function(e){return F.ExprResult.result(e)}},{key:"interpretRules",value:function(r){for(var t=0;t<r.length;t++){var n=r[t];if(this.interpretExpr(n.expr))return n.result}throw new e.InterpretErrors.NoRuleResultError}}]),t}();e.SemanticErrors=void 0,function(e){var t=function(e){a(o,e);var t=p(o);function o(e,n,a){var u;return r(this,o),(u=t.call(this,"op is not match at ( left op right ): (".concat(n," ").concat(e," ").concat(a,")"))).op=e,u.left=n,u.right=a,u}return n(o)}(l(Error));e.OpNotMatchError=t;var o=function(e){a(o,e);var t=p(o);function o(e){return r(this,o),t.call(this,"variable ".concat(e," not found"))}return n(o)}(l(Error));e.VariableNotFoundError=o}(e.SemanticErrors||(e.SemanticErrors={}));var K=function(){function t(){r(this,t)}return n(t,[{key:"matchExpr",value:function(e){var r=e.left,t=e.op,n=e.right;if((null==r?void 0:r.constructor)===w&&(null==n?void 0:n.constructor)===w||(null==r?void 0:r.constructor)===O&&(null==n?void 0:n.constructor)===y||(null==r?void 0:r.constructor)===O&&(null==n?void 0:n.constructor)===O)this.matchOp(t,r,n),(null==r?void 0:r.constructor)===O&&this.matchVar(r),(null==n?void 0:n.constructor)===O&&this.matchVar(n);else{if((null==r?void 0:r.constructor)!==w||null!==t||null!==n)return!1;this.matchExpr(r)}}},{key:"matchOp",value:function(r,t,n){if(t.constructor===w&&n.constructor===w){if(-1===[e.Operator.AND,e.Operator.OR].indexOf(r.op))throw new e.SemanticErrors.OpNotMatchError(r,t,n)}else if((t.constructor===O&&n.constructor===y||t.constructor===O&&n.constructor===O)&&-1===[e.Operator.EQ,e.Operator.NE,e.Operator.LT,e.Operator.GT,e.Operator.LTE,e.Operator.GTE].indexOf(r.op))throw new e.SemanticErrors.OpNotMatchError(r,t,n)}},{key:"matchVar",value:function(r){if(!r.context.variableStore.findByName(r.name))throw new e.SemanticErrors.VariableNotFoundError(r.name)}}]),t}();e.Expr=w,e.ExprParser=_,e.Facade=z,e.Interpreter=$,e.Op=m,e.Rule=E,e.RuleParser=j,e.Semantic=K,e.Token=P,e.Value=y,e.ValueHolder=R,e.Var=O,e.Variable=T,e.VariableStore=N,Object.defineProperty(e,"__esModule",{value:!0})}));
